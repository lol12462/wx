-- Создаем ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HighlightToggleMenu"
screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

-- Создаем кнопку
local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 200, 0, 50)
button.Position = UDim2.new(0.5, -100, 0.5, -25)
button.Text = "Выключить Вх"
button.BackgroundColor3 = Color3.fromRGB(0, 170, 255) -- Голубой фон
button.TextColor3 = Color3.fromRGB(255, 255, 255) -- Белый текст
button.Font = Enum.Font.SourceSansBold
button.TextSize = 20
button.BorderSizePixel = 0
button.Parent = screenGui

-- Добавляем круглые края
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 12)
uiCorner.Parent = button

-- Добавляем тень
local shadow = Instance.new("Frame")
shadow.Size = UDim2.new(1, 8, 1, 8)
shadow.Position = UDim2.new(0, -4, 0, -4)
shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
shadow.BackgroundTransparency = 0.5
shadow.BorderSizePixel = 0
shadow.ZIndex = 0
shadow.Parent = button

local shadowCorner = Instance.new("UICorner")
shadowCorner.CornerRadius = UDim.new(0, 12)
shadowCorner.Parent = shadow

-- Делаем кнопку перетаскиваемой
local dragging = false
local dragStart, startPos

button.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = button.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

button.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        button.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Флаг состояния работы подсветки
local isHighlightActive = true

-- Локальный скрипт для подсветки игроков через стены
local player = game.Players.LocalPlayer
local players = game:GetService("Players")
local runService = game:GetService("RunService")

local highlightColor = Color3.fromRGB(0, 255, 0) -- Цвет подсветки (зелёный)

-- Функция для создания подсветки вокруг головы игрока
local function createGlowEffect(targetPlayer)
    -- Проверяем, есть ли у игрока персонаж и часть "Head"
    if targetPlayer.Character and targetPlayer.Character:FindFirstChild("Head") then
        local character = targetPlayer.Character
        local head = character:FindFirstChild("Head")
        
        -- Проверка, чтобы не создавать подсветку дважды
        local existingGlow = character:FindFirstChild("GlowBox")
        if existingGlow then
            return
        end

        -- Создаём BillboardGui для подсветки
        local glowGui = Instance.new("BillboardGui")
        glowGui.Name = "GlowBox"
        glowGui.Parent = character
        glowGui.Adornee = head  -- Привязываем подсветку к голове
        glowGui.Size = UDim2.new(0, 10, 0, 10)  -- Размер подсветки (квадрат)
        glowGui.StudsOffset = Vector3.new(0, 0, 0)  -- Подсветка на уровне головы

        -- Настройка рамки
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 10, 0, 10)  -- Размер квадратика (площадь 10x10)
        frame.BackgroundTransparency = 0.5
        frame.BackgroundColor3 = highlightColor
        frame.BorderSizePixel = 0
        frame.Parent = glowGui

        -- Настройка рамки для подсветки
        local outline = Instance.new("UIStroke")
        outline.Thickness = 2
        outline.Color = highlightColor
        outline.Parent = frame

        -- Включение всегда на переднем плане
        glowGui.AlwaysOnTop = true
    end
end

-- Функция для удаления подсветки
local function removeGlowEffect(targetPlayer)
    if targetPlayer.Character then
        local glowBox = targetPlayer.Character:FindFirstChild("GlowBox")
        if glowBox then
            glowBox:Destroy()
        end
    end
end

-- Обновление подсветки для всех игроков
local function updateGlowEffects()
    if not isHighlightActive then return end
    for _, targetPlayer in pairs(players:GetPlayers()) do
        if targetPlayer ~= player then
            createGlowEffect(targetPlayer)
        end
    end
end

-- Обработчик появления нового игрока
players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.CharacterAdded:Connect(function()
        if isHighlightActive then
            createGlowEffect(newPlayer)
        end
    end)
end)

-- Обработчик удаления игрока
players.PlayerRemoving:Connect(function(leavingPlayer)
    removeGlowEffect(leavingPlayer)
end)

-- Постоянное обновление подсветки
runService.Heartbeat:Connect(updateGlowEffects)

-- Применяем подсветку ко всем игрокам при старте
updateGlowEffects()

-- Обработчик нажатия кнопки
button.MouseButton1Click:Connect(function()
    isHighlightActive = not isHighlightActive
    if isHighlightActive then
        button.Text = "Выключить Вх"
        updateGlowEffects()
    else
        button.Text = "Включить Вх"
        -- Удаляем подсветку у всех игроков
        for _, targetPlayer in pairs(players:GetPlayers()) do
            removeGlowEffect(targetPlayer)
        end
    end
end)
